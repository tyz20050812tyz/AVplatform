# 数据管理系统

<cite>
**本文档引用的文件**  
- [main.py](file://src/main.py)
- [auth.py](file://src/auth.py)
- [check_db.py](file://src/check_db.py)
- [data.db](file://data/data.db)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细阐述无人驾驶数据管理平台的实现机制，重点分析数据集上传、浏览、可视化及删除功能的完整流程。系统基于Streamlit构建，采用SQLite作为元数据存储，支持多模态传感器数据的统一管理。文档深入解析`main.py`中`show_upload_page`、`show_browse_page`等关键函数的实现逻辑，说明文件存储策略、路径管理与并发控制机制，并为开发者提供扩展支持的指导方案。

## 项目结构
系统采用模块化设计，主要分为配置、数据、脚本、源码和测试五大目录。源码集中于`src`目录，核心功能由`main.py`驱动，`auth.py`负责用户认证，`check_db.py`用于数据库调试。数据文件存储在`datasets/`目录，元数据统一管理于`data.db`数据库中。

```mermaid
graph TD
A[平台根目录] --> B[config]
A --> C[data]
A --> D[scripts]
A --> E[src]
A --> F[test]
B --> B1[pyproject.toml]
B --> B2[requirements.txt]
C --> C1[temp_pointclouds]
C --> C2[datasets/]
D --> D1[start_app.bat]
D --> D2[start_app.sh]
E --> E1[main.py]
E --> E2[auth.py]
E --> E3[check_db.py]
E --> E4[demo_login.py]
E --> E5[project_status.py]
F --> F1[test_auth.py]
F --> F2[test_basic.py]
F --> F3[test_pointcloud.py]
F --> F4[test_pointcloud_unit.py]
```

**Diagram sources**
- [main.py](file://src/main.py#L1-L806)
- [project_structure](file://.)

**Section sources**
- [main.py](file://src/main.py#L1-L806)
- [project_structure](file://.)

## 核心组件
系统核心功能由`main.py`中的多个函数实现，包括数据上传、浏览、可视化及删除。`init_database`负责初始化SQLite数据库结构，`show_upload_page`处理文件上传逻辑，`show_browse_page`提供数据集列表展示，`delete_dataset`确保文件与数据库记录的安全删除。用户认证由`auth.py`模块独立管理，保障系统访问安全。

**Section sources**
- [main.py](file://src/main.py#L382-L805)
- [auth.py](file://src/auth.py#L1-L562)

## 架构概述
系统采用前后端一体化架构，Streamlit作为前端框架直接渲染Python逻辑。用户通过Web界面交互，后端处理文件存储与数据库操作。文件物理存储于`datasets/`目录，元数据（名称、描述、路径列表）存入SQLite数据库。各功能模块通过`main.py`中的`main`函数路由调度，形成清晰的控制流。

```mermaid
graph TD
A[用户界面] --> B[Streamlit应用]
B --> C{功能选择}
C --> D[数据上传]
C --> E[数据浏览]
C --> F[数据可视化]
D --> G[文件上传器]
G --> H[保存至datasets/]
H --> I[写入data.db]
E --> J[查询data.db]
J --> K[展示数据集列表]
F --> L[按类型解析文件]
L --> M[调用可视化函数]
I --> N[(SQLite数据库)]
H --> O[(文件系统)]
N --> P[数据集表]
O --> Q[时间戳命名目录]
```

**Diagram sources**
- [main.py](file://src/main.py#L756-L805)
- [data.db](file://data/data.db)

**Section sources**
- [main.py](file://src/main.py#L756-L805)
- [data.db](file://data/data.db)

## 详细组件分析

### 数据上传流程分析
该模块实现从用户选择文件到元数据入库的完整流程。首先通过`st.file_uploader`获取文件对象，创建以数据集名和时间戳命名的子目录，将文件逐个写入该目录。随后，将文件路径列表以逗号分隔的字符串形式存入数据库的`file_paths`字段，同时记录名称、描述、上传时间等元数据。

```mermaid
flowchart TD
Start([用户进入上传页面]) --> Input["输入数据集名称和描述"]
Input --> Upload["选择多个文件上传"]
Upload --> Validate{"名称和文件非空?"}
Validate --> |否| Error["显示错误提示"]
Validate --> |是| CreateDir["创建datasets/名称_时间戳目录"]
CreateDir --> SaveFiles["遍历并保存每个文件"]
SaveFiles --> CollectPaths["收集所有文件的完整路径"]
CollectPaths --> ConnectDB["连接data.db数据库"]
ConnectDB --> Insert["插入元数据记录"]
Insert --> Commit["提交事务"]
Commit --> Success["显示上传成功"]
Success --> End([上传流程结束])
Error --> End
```

**Diagram sources**
- [main.py](file://src/main.py#L464-L498)

**Section sources**
- [main.py](file://src/main.py#L464-L498)

### 数据浏览功能分析
该功能从数据库查询所有数据集，按上传时间倒序排列，并支持名称搜索。对于每个数据集，系统解析其`file_paths`字段，检查文件是否存在，并在前端展示文件名与大小。用户可通过“查看详情”或“删除数据集”按钮进行后续操作。

```mermaid
flowchart TD
Start([进入浏览页面]) --> QueryDB["执行SQL: SELECT * FROM datasets"]
QueryDB --> Sort["按upload_time降序排序"]
Sort --> CheckEmpty{"数据集为空?"}
CheckEmpty --> |是| ShowEmpty["显示'暂无数据集'"]
CheckEmpty --> |否| ShowSearch["显示搜索框"]
ShowSearch --> Filter["根据搜索词过滤"]
Filter --> Loop["遍历每个数据集"]
Loop --> Expand["创建可展开面板"]
Expand --> ShowMeta["显示名称、描述、时间"]
ShowMeta --> SplitPaths["分割file_paths字符串"]
SplitPaths --> CheckExist["检查每个文件是否存在"]
CheckExist --> DisplayList["展示文件列表及大小"]
DisplayList --> AddButtons["添加'查看详情'和'删除'按钮"]
AddButtons --> NextDataset
NextDataset --> Loop
ShowEmpty --> End
AddButtons --> End
```

**Diagram sources**
- [main.py](file://src/main.py#L525-L568)

**Section sources**
- [main.py](file://src/main.py#L525-L568)

### 数据删除机制分析
`delete_dataset`函数实现安全删除。首先根据`dataset_id`查询数据库获取所有文件路径，逐个删除物理文件。随后检查文件所在目录是否为空，若是则删除该目录。最后从数据库中删除对应记录，确保文件系统与数据库状态一致。

```mermaid
flowchart TD
Start([调用delete_dataset]) --> Connect["连接data.db"]
Connect --> Query["SELECT file_paths WHERE id=?"]
Query --> GetResult["获取文件路径字符串"]
GetResult --> Split{"路径存在?"}
Split --> |否| DeleteRecord["直接删除数据库记录"]
Split --> |是| LoopFiles["遍历每个文件路径"]
LoopFiles --> Exists{"文件存在?"}
Exists --> |是| DeleteFile["os.remove()删除文件"]
Exists --> |否| NextFile
DeleteFile --> NextFile
NextFile --> LoopFiles
LoopFiles --> GetDir["获取第一个文件的目录"]
GetDir --> IsEmpty{"目录存在且为空?"}
IsEmpty --> |是| RemoveDir["os.rmdir()删除目录"]
IsEmpty --> |否| SkipDir
RemoveDir --> SkipDir
SkipDir --> DeleteRecord
DeleteRecord --> Commit["提交事务"]
Commit --> Success["显示删除成功"]
Success --> End([删除流程结束])
```

**Diagram sources**
- [main.py](file://src/main.py#L715-L749)

**Section sources**
- [main.py](file://src/main.py#L715-L749)

## 依赖分析
系统依赖关系清晰，`main.py`为核心模块，依赖`auth.py`进行用户认证，依赖SQLite进行数据持久化。外部库包括Streamlit（UI）、pandas（数据处理）、plotly（可视化）、open3d/laspy（点云处理）等。数据库`data.db`包含`datasets`和`users`两张表，分别由`main.py`和`auth.py`初始化。

```mermaid
graph TD
A[main.py] --> B[auth.py]
A --> C[sqlite3]
A --> D[pandas]
A --> E[streamlit]
A --> F[plotly]
A --> G[PIL]
A --> H[yaml]
A --> I[json]
A --> J[cv2]
A --> K[numpy]
A --> L[open3d]
A --> M[laspy]
B --> C
B --> E
N[data.db] --> O[datasets表]
N --> P[users表]
A --> N
B --> N
```

**Diagram sources**
- [main.py](file://src/main.py#L1-L20)
- [auth.py](file://src/auth.py#L1-L20)
- [data.db](file://data/data.db)

**Section sources**
- [main.py](file://src/main.py#L1-L806)
- [auth.py](file://src/auth.py#L1-L562)
- [data.db](file://data/data.db)

## 性能考虑
系统在文件上传和可视化时采用流式处理，避免内存溢出。点云可视化支持采样显示，限制最大点数以保证渲染性能。数据库查询使用`pd.read_sql_query`高效加载数据集列表。建议生产环境对大文件上传增加分块处理，对数据库查询添加索引优化。

## 故障排除指南
常见问题包括文件上传失败（检查目录权限）、点云无法显示（确认Open3D安装）、数据库连接错误（检查`data.db`路径）。可通过运行`check_db.py`验证数据库状态，使用`demo_login.py`测试认证流程。日志信息通过Streamlit的`st.error`和`st.warning`直接反馈给用户。

**Section sources**
- [main.py](file://src/main.py#L494-L497)
- [main.py](file://src/main.py#L745-L748)
- [check_db.py](file://src/check_db.py#L1-L14)

## 结论
本系统实现了完整的数据管理闭环，从上传、存储、浏览到删除，逻辑清晰，结构合理。通过SQLite统一管理元数据，文件系统存储原始数据，兼顾了灵活性与可靠性。代码结构模块化，易于维护和扩展。开发者可参考现有模式添加新文件类型支持或调整存储策略。