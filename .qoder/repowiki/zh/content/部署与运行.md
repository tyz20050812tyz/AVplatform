# 部署与运行

<cite>
**本文档引用文件**  
- [start_app.bat](file://scripts/start_app.bat)
- [start_app.sh](file://scripts/start_app.sh)
- [project_status.py](file://src/project_status.py)
- [requirements.txt](file://config/requirements.txt)
- [main.py](file://src/main.py)
- [auth.py](file://src/auth.py)
</cite>

## 目录
1. [简介](#简介)
2. [环境准备](#环境准备)
3. [启动应用](#启动应用)
4. [项目状态检查工具](#项目状态检查工具)
5. [Docker化部署建议](#docker化部署建议)
6. [生产环境配置](#生产环境配置)
7. [故障排除指南](#故障排除指南)
8. [监控与维护建议](#监控与维护建议)
9. [完整操作流程](#完整操作流程)

## 简介
本文档提供无人驾驶数据管理平台的详细部署与运行指南。涵盖从环境配置到系统维护的完整生命周期管理，包括脚本启动、状态检查、容器化部署和生产环境最佳实践。

## 环境准备

### Python环境要求
- Python版本：3.9及以上
- 包管理工具：pip
- 虚拟环境建议：使用venv或conda创建隔离环境

### 依赖安装步骤
1. 克隆项目仓库
2. 进入项目根目录
3. 安装依赖包

```bash
pip install -r config/requirements.txt
```

**关键依赖说明**：
- `streamlit==1.29.0`：Web应用框架
- `open3d==0.18.0`：点云处理核心库
- `numpy==1.24.0`：数值计算基础
- `sqlite3`：内置数据库支持

**Section sources**
- [requirements.txt](file://config/requirements.txt#L1-L12)

## 启动应用

### Windows系统启动
使用`start_app.bat`批处理脚本启动：

```bat
@echo off
REM 点云可视化平台启动脚本 (Windows)

echo 🚀 启动无人驾驶数据管理平台
echo ==============================

REM 检查Python版本
python --version

REM 安装依赖包
pip install -r requirements.txt

REM 创建测试数据
python test_pointcloud.py

REM 启动Streamlit应用
streamlit run main.py
```

### Linux/macOS系统启动
使用`start_app.sh` shell脚本启动：

```bash
#!/bin/bash
# 点云可视化平台启动脚本

echo "🚀 启动无人驾驶数据管理平台"
echo "=============================="

# 检查Python版本
python --version

# 安装依赖包
pip install -r requirements.txt

# 创建测试数据
python test_pointcloud.py

# 启动Streamlit应用
streamlit run main.py
```

### 启动流程说明
1. 检查Python环境
2. 安装所需依赖包
3. 生成测试用点云数据
4. 启动Streamlit Web服务
5. 自动打开浏览器访问`http://localhost:8501`

**默认登录账户**：
- 用户名：admin
- 密码：admin123

**Section sources**
- [start_app.bat](file://scripts/start_app.bat#L1-L26)
- [start_app.sh](file://scripts/start_app.sh#L1-L24)

## 项目状态检查工具

### project_status.py功能
`project_status.py`是一个综合性的项目状态检查工具，用于验证系统完整性和功能可用性。

```python
def check_project_status():
    """检查项目状态"""
    print("🚗 无人驾驶数据管理平台 - 功能验证总结")
    
    # 文件存在性检查
    required_files = [
        ("main.py", "主应用程序"),
        ("auth.py", "用户认证模块"),
        ("data.db", "SQLite数据库")
    ]
    
    # 数据库检查
    try:
        import sqlite3
        conn = sqlite3.connect('data.db')
        # 检查表结构
        c.execute("SELECT name FROM sqlite_master WHERE type='table'")
        tables = [t[0] for t in c.fetchall()]
    except Exception as e:
        print(f"❌ 数据库检查失败: {e}")
    
    # 依赖检查
    dependencies = [
        ("streamlit", "Web框架", False),
        ("open3d", "点云处理", False)
    ]
    
    # 功能验证
    print("\n🎯 功能验证:")
    # 认证功能测试
    # 点云功能测试
```

### 检查项目
- **文件完整性**：验证关键文件是否存在
- **数据库状态**：检查users、datasets等表结构
- **依赖项**：确认必需和可选库的安装状态
- **功能验证**：测试认证和点云处理功能
- **总结报告**：生成详细的系统状态摘要

**使用方法**：
```bash
python src/project_status.py
```

**Section sources**
- [project_status.py](file://src/project_status.py#L1-L147)

## Docker化部署建议

### Dockerfile建议方案
```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY . .

RUN pip install --no-cache-dir -r config/requirements.txt

EXPOSE 8501

CMD ["streamlit", "run", "src/main.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

### docker-compose.yml
```yaml
version: '3.8'
services:
  platform:
    build: .
    ports:
      - "8501:8501"
    volumes:
      - ./data:/app/data
      - ./datasets:/app/datasets
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_HEADLESS=true
    restart: unless-stopped
```

### 部署优势
- **环境一致性**：确保开发、测试、生产环境一致
- **快速部署**：一键启动完整应用环境
- **资源隔离**：避免依赖冲突
- **可扩展性**：便于集群部署和负载均衡

**Section sources**
- [requirements.txt](file://config/requirements.txt#L1-L12)
- [main.py](file://src/main.py#L1-L799)

## 生产环境配置

### 会话安全配置
- **会话超时**：24小时自动失效
- **密码策略**：
  - 最小长度：6位
  - 必须包含字母和数字
  - 使用PBKDF2-HMAC-SHA256哈希
- **账户锁定**：5次失败登录后锁定1小时
- **CSRF保护**：基于随机token的会话机制

### 数据库备份策略
- **备份频率**：每日凌晨2点自动备份
- **备份位置**：本地+云存储双重备份
- **保留周期**：最近7天完整备份
- **备份脚本示例**：
```bash
#!/bin/bash
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
cp data.db backups/data_${TIMESTAMP}.db
# 上传到云存储...
```

### 日志管理
- **日志级别**：INFO及以上
- **日志位置**：logs/app.log
- **轮转策略**：每日轮转，保留30天
- **关键日志事件**：
  - 用户登录/登出
  - 数据上传/删除
  - 系统错误
  - 安全事件

**Section sources**
- [auth.py](file://src/auth.py#L1-L561)
- [main.py](file://src/main.py#L1-L799)

## 故障排除指南

### 常见启动问题及解决方案

#### 端口占用问题
**症状**：`OSError: [Errno 98] Address already in use`
**解决方案**：
```bash
# 查找占用8501端口的进程
lsof -i :8501  # macOS/Linux
netstat -ano | findstr :8501  # Windows

# 终止进程
kill -9 <PID>  # macOS/Linux
taskkill /PID <PID> /F  # Windows

# 或更改端口
streamlit run main.py --server.port=8502
```

#### 依赖缺失问题
**症状**：`ModuleNotFoundError: No module named 'xxx'`
**解决方案**：
```bash
# 确保在正确目录
cd 

# 重新安装依赖
pip install -r config/requirements.txt

# 单独安装关键依赖
pip install streamlit open3d numpy
```

#### 数据库连接问题
**症状**：`sqlite3.OperationalError: unable to open database file`
**解决方案**：
```python
# 检查数据库文件权限
import os
if not os.access('data.db', os.W_OK):
    # 创建数据库
    open('data.db', 'a').close()
```

#### 点云库问题
**症状**：Open3D相关错误
**解决方案**：
```bash
# 重新安装open3d
pip uninstall open3d
pip install open3d==0.18.0

# 检查CUDA版本兼容性
nvidia-smi
```

**Section sources**
- [start_app.bat](file://scripts/start_app.bat#L1-L26)
- [start_app.sh](file://scripts/start_app.sh#L1-L24)
- [project_status.py](file://src/project_status.py#L1-L147)

## 监控与维护建议

### 性能指标收集
- **CPU使用率**：监控Python进程
- **内存使用**：关注点云加载时的峰值
- **磁盘I/O**：数据库读写性能
- **网络流量**：Web请求响应

### 定期健康检查
```python
def health_check():
    """系统健康检查"""
    checks = {
        "database": check_database(),
        "storage": check_storage_space(),
        "dependencies": check_dependencies(),
        "web_service": check_web_service()
    }
    return all(checks.values())
```

### 维护任务
- **每周**：检查磁盘空间，清理临时文件
- **每月**：更新依赖包，安全补丁
- **每季度**：性能优化，架构评估
- **实时**：监控异常登录尝试

### 监控工具建议
- **Prometheus + Grafana**：指标收集与可视化
- **ELK Stack**：日志分析
- **Sentry**：错误跟踪
- **自定义脚本**：定时执行`project_status.py`

**Section sources**
- [project_status.py](file://src/project_status.py#L1-L147)
- [main.py](file://src/main.py#L1-L799)

## 完整操作流程

### 从克隆到访问的完整步骤
1. **克隆仓库**
```bash
git clone <repository-url>
cd platform
```

2. **创建虚拟环境**
```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
venv\Scripts\activate     # Windows
```

3. **安装依赖**
```bash
pip install -r config/requirements.txt
```

4. **验证项目状态**
```bash
python src/project_status.py
```

5. **启动应用**
```bash
# Windows
scripts\start_app.bat

# Linux/macOS
chmod +x scripts/start_app.sh
scripts/start_app.sh
```

6. **访问Web界面**
- 打开浏览器
- 访问 `http://localhost:8501`
- 使用admin/admin123登录

7. **首次配置**
- 修改默认管理员密码
- 配置数据存储路径
- 设置备份策略

**成功标志**：
- 浏览器正常显示"无人驾驶数据管理平台"
- 能够成功登录
- 状态检查工具显示所有功能正常

**Section sources**
- [start_app.bat](file://scripts/start_app.bat#L1-L26)
- [start_app.sh](file://scripts/start_app.sh#L1-L24)
- [project_status.py](file://src/project_status.py#L1-L147)
- [main.py](file://src/main.py#L1-L799)