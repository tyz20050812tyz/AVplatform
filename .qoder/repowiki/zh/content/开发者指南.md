# å¼€å‘è€…æŒ‡å—

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**   
- [main.py](file://src/main.py)
- [auth.py](file://src/auth.py)
- [pyproject.toml](file://config/pyproject.toml)
- [requirements.txt](file://config/requirements.txt)
- [project_status.py](file://src/project_status.py)
- [demo_login.py](file://src/demo_login.py)
</cite>

## ç›®å½•
1. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
2. [MVCæ¶æ„è®¾è®¡](#mvcæ¶æ„è®¾è®¡)
3. [ä»£ç è´¡çŒ®æµç¨‹](#ä»£ç è´¡çŒ®æµç¨‹)
4. [ç³»ç»ŸåŠŸèƒ½æ‰©å±•](#ç³»ç»ŸåŠŸèƒ½æ‰©å±•)
5. [ä»£ç é£æ ¼ä¸æœ€ä½³å®è·µ](#ä»£ç é£æ ¼ä¸æœ€ä½³å®è·µ)
6. [è°ƒè¯•æŠ€å·§ä¸å¼€å‘å·¥å…·](#è°ƒè¯•æŠ€å·§ä¸å¼€å‘å·¥å…·)
7. [å®‰å…¨æ€§æœ€ä½³å®è·µ](#å®‰å…¨æ€§æœ€ä½³å®è·µ)

## é¡¹ç›®ç»“æ„

æœ¬é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚ç»“æ„ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ï¼š

```
platform/
â”œâ”€â”€ config/              # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ pyproject.toml   # Pythoné¡¹ç›®é…ç½®
â”‚   â””â”€â”€ requirements.txt # ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ data/                # æ•°æ®å­˜å‚¨ç›®å½•
â”‚   â””â”€â”€ temp_pointclouds # ä¸´æ—¶ç‚¹äº‘æ•°æ®
â”œâ”€â”€ scripts/             # å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ start_app.bat    # Windowså¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ start_app.sh     # Linux/Macå¯åŠ¨è„šæœ¬
â”œâ”€â”€ src/                 # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ auth.py          # è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ check_db.py      # æ•°æ®åº“æ£€æŸ¥
â”‚   â”œâ”€â”€ demo_login.py    # ç™»å½•æ¼”ç¤º
â”‚   â”œâ”€â”€ main.py          # ä¸»åº”ç”¨å…¥å£
â”‚   â””â”€â”€ project_status.py # é¡¹ç›®çŠ¶æ€æ£€æŸ¥
â””â”€â”€ test/                # æµ‹è¯•ç›®å½•
    â”œâ”€â”€ test_auth.py     # è®¤è¯æµ‹è¯•
    â”œâ”€â”€ test_basic.py    # åŸºç¡€æµ‹è¯•
    â”œâ”€â”€ test_pointcloud.py # ç‚¹äº‘æµ‹è¯•
    â””â”€â”€ test_pointcloud_unit.py # ç‚¹äº‘å•å…ƒæµ‹è¯•
```

**æ–‡æ¡£æ¥æº**
- [main.py](file://src/main.py)
- [auth.py](file://src/auth.py)
- [requirements.txt](file://config/requirements.txt)

## MVCæ¶æ„è®¾è®¡

æœ¬å¹³å°é‡‡ç”¨MVCï¼ˆModel-View-Controllerï¼‰æ¶æ„æ¨¡å¼ï¼Œå®ç°äº†å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

```mermaid
graph TD
subgraph "View (è§†å›¾)"
StreamlitUI[Streamlit UI]
end
subgraph "Controller (æ§åˆ¶å™¨)"
MainPy[main.py]
end
subgraph "Model (æ¨¡å‹)"
AuthPy[auth.py]
Database[(data.db)]
FileStorage[(æ–‡ä»¶å­˜å‚¨)]
end
StreamlitUI --> MainPy
MainPy --> AuthPy
MainPy --> Database
MainPy --> FileStorage
AuthPy --> Database
```

**å›¾ç¤ºæ¥æº**
- [main.py](file://src/main.py)
- [auth.py](file://src/auth.py)

### æ§åˆ¶å™¨ (main.py)

`main.py`ä½œä¸ºæ ¸å¿ƒæ§åˆ¶å™¨ï¼Œè´Ÿè´£åè°ƒè§†å›¾å’Œæ¨¡å‹ä¹‹é—´çš„äº¤äº’ï¼š

```mermaid
graph TD
Main[main.py] --> InitDB[init_database]
Main --> InitAuth[init_auth_database]
Main --> CheckAuth[check_authentication]
Main --> ShowAuth[show_auth_page]
Main --> ShowUserInfo[show_user_info]
Main --> ShowHomepage[show_homepage]
Main --> ShowUpload[show_upload_page]
Main --> ShowBrowse[show_browse_page]
Main --> ShowVisual[show_visualization_page]
Main --> DeleteDataset[delete_dataset]
Main --> LoadPC[load_point_cloud]
Main --> VisualSingle[visualize_single_pointcloud]
Main --> VisualMulti[visualize_multiple_pointclouds]
```

**å›¾ç¤ºæ¥æº**
- [main.py](file://src/main.py#L0-L806)

### æ¨¡å‹å±‚

æ¨¡å‹å±‚åŒ…å«æ•°æ®è®¿é—®å’Œä¸šåŠ¡é€»è¾‘ï¼š

1. **è®¤è¯æ¨¡å‹ (auth.py)**ï¼šå¤„ç†ç”¨æˆ·è®¤è¯ã€ä¼šè¯ç®¡ç†å’Œå®‰å…¨éªŒè¯
2. **æ•°æ®æ¨¡å‹**ï¼šé€šè¿‡SQLiteæ•°æ®åº“ç®¡ç†æ•°æ®é›†å…ƒæ•°æ®
3. **æ–‡ä»¶æ¨¡å‹**ï¼šç®¡ç†ç‚¹äº‘æ–‡ä»¶å’Œå…¶ä»–ä¼ æ„Ÿå™¨æ•°æ®çš„å­˜å‚¨

```mermaid
classDiagram
class auth {
+init_auth_database()
+check_authentication()
+show_auth_page()
+show_user_info()
+logout_user()
+register_user()
+authenticate_user()
+create_user_session()
+verify_session()
}
class main {
+init_database()
+show_homepage()
+show_upload_page()
+show_browse_page()
+show_visualization_page()
+delete_dataset()
+load_point_cloud()
+visualize_single_pointcloud()
+visualize_multiple_pointclouds()
}
auth --> main : "uses"
main --> Database : "manages"
main --> FileStorage : "manages"
```

**å›¾ç¤ºæ¥æº**
- [auth.py](file://src/auth.py#L0-L562)
- [main.py](file://src/main.py#L0-L806)

### è§†å›¾å±‚

è§†å›¾å±‚åŸºäºStreamlitæ„å»ºï¼Œæä¾›ç›´è§‚çš„Webç•Œé¢ï¼š

```mermaid
flowchart TD
Start([åº”ç”¨å¯åŠ¨]) --> SetConfig["st.set_page_config()"]
SetConfig --> InitDB["åˆå§‹åŒ–æ•°æ®åº“"]
InitDB --> CheckAuth["æ£€æŸ¥è®¤è¯çŠ¶æ€"]
CheckAuth --> AuthValid{"å·²è®¤è¯?"}
AuthValid --> |å¦| ShowAuth["æ˜¾ç¤ºç™»å½•é¡µé¢"]
AuthValid --> |æ˜¯| ShowSidebar["æ˜¾ç¤ºä¾§è¾¹æ "]
ShowSidebar --> ShowUserInfo["æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯"]
ShowSidebar --> ShowNav["æ˜¾ç¤ºå¯¼èˆªèœå•"]
ShowNav --> PageSelect{"é€‰æ‹©é¡µé¢"}
PageSelect --> Homepage["é¦–é¡µ"]
PageSelect --> Upload["æ•°æ®ä¸Šä¼ "]
PageSelect --> Browse["æ•°æ®æµè§ˆ"]
PageSelect --> Visual["æ•°æ®å¯è§†åŒ–"]
Homepage --> End
Upload --> End
Browse --> End
Visual --> End
```

**å›¾ç¤ºæ¥æº**
- [main.py](file://src/main.py#L0-L806)

## ä»£ç è´¡çŒ®æµç¨‹

### ç¯å¢ƒæ­å»º

1. **å…‹éš†ä»“åº“**
```bash
git clone https://github.com/your-repo/platform.git
cd platform
```

2. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ–
venv\Scripts\activate     # Windows
```

3. **å®‰è£…ä¾èµ–**
```bash
pip install -r config/requirements.txt
```

4. **éªŒè¯å®‰è£…**
```bash
python src/project_status.py
```

### å¼€å‘æµç¨‹

1. **åˆ›å»ºç‰¹æ€§åˆ†æ”¯**
```bash
git checkout -b feature/new-visualization
```

2. **è¿›è¡Œä»£ç ä¿®æ”¹**
éµå¾ªä»£ç é£æ ¼è§„èŒƒï¼Œæ·»åŠ å¿…è¦çš„å•å…ƒæµ‹è¯•

3. **è¿è¡Œæµ‹è¯•**
```bash
python test/test_auth.py
python test/test_pointcloud.py
```

4. **æäº¤æ›´æ”¹**
```bash
git add .
git commit -m "æ·»åŠ æ–°çš„å¯è§†åŒ–åŠŸèƒ½"
```

5. **æ¨é€åˆ†æ”¯**
```bash
git push origin feature/new-visualization
```

### Pull Requestæµç¨‹

1. åœ¨GitHubä¸Šåˆ›å»ºPull Request
2. å¡«å†™PRæè¿°ï¼Œè¯´æ˜æ›´æ”¹å†…å®¹å’Œå½±å“
3. ç­‰å¾…ä»£ç å®¡æŸ¥
4. æ ¹æ®åé¦ˆè¿›è¡Œä¿®æ”¹
5. åˆå¹¶åˆ°ä¸»åˆ†æ”¯

**æ–‡æ¡£æ¥æº**
- [requirements.txt](file://config/requirements.txt)
- [project_status.py](file://src/project_status.py)
- [test/](file://test/)

## ç³»ç»ŸåŠŸèƒ½æ‰©å±•

### æ·»åŠ æ–°çš„æ–‡ä»¶æ ¼å¼æ”¯æŒ

ä»¥æ·»åŠ ROS bagæ–‡ä»¶è§£æä¸ºä¾‹ï¼š

1. **å®‰è£…ä¾èµ–**
```bash
pip install rosbag rospy
```

2. **ä¿®æ”¹`main.py`ä¸­çš„`load_point_cloud`å‡½æ•°**
```python
elif file_path.endswith('.bag'):
    try:
        import rosbag
        bag = rosbag.Bag(file_path)
        # è§£æbagæ–‡ä»¶ä¸­çš„ç‚¹äº‘æ•°æ®
        # è¿”å›points, colors
    except ImportError:
        st.error("éœ€è¦å®‰è£…rosbagåº“æ¥è¯»å–.bagæ–‡ä»¶")
        return None, None
```

3. **æ›´æ–°æ–‡ä»¶ä¸Šä¼ ç±»å‹**
```python
uploaded_files = st.file_uploader(
    "é€‰æ‹©æ–‡ä»¶",
    accept_multiple_files=True,
    type=['bag', 'pcd', 'png', 'jpg', 'yaml', 'yml', 'csv', 'json'],
    help="æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š.bag, .pcd, .png, .jpg, .yaml, .yml, .csv, .json"
)
```

**æ–‡æ¡£æ¥æº**
- [main.py](file://src/main.py#L29-L71)
- [requirements.txt](file://config/requirements.txt)

### é›†æˆç¬¬ä¸‰æ–¹è®¤è¯æœåŠ¡

ä»¥é›†æˆOAuth2ä¸ºä¾‹ï¼š

1. **å®‰è£…ä¾èµ–**
```bash
pip install requests-oauthlib
```

2. **åˆ›å»ºè®¤è¯æœåŠ¡ç±»**
```python
# src/oauth_service.py
class OAuthService:
    def __init__(self, client_id, client_secret, redirect_uri):
        self.client_id = client_id
        self.client_secret = client_secret
        self.redirect_uri = redirect_uri
    
    def get_authorization_url(self):
        # ç”ŸæˆæˆæƒURL
        pass
    
    def exchange_code_for_token(self, code):
        # äº¤æ¢æˆæƒç è·å–token
        pass
    
    def get_user_info(self, access_token):
        # è·å–ç”¨æˆ·ä¿¡æ¯
        pass
```

3. **åœ¨`auth.py`ä¸­é›†æˆ**
```python
# åœ¨auth.pyä¸­æ·»åŠ 
from oauth_service import OAuthService

def init_oauth_service():
    return OAuthService(
        client_id=os.getenv('OAUTH_CLIENT_ID'),
        client_secret=os.getenv('OAUTH_CLIENT_SECRET'),
        redirect_uri=os.getenv('OAUTH_REDIRECT_URI')
    )
```

**æ–‡æ¡£æ¥æº**
- [auth.py](file://src/auth.py)
- [requirements.txt](file://config/requirements.txt)

### å¼€å‘æ–°çš„å¯è§†åŒ–æ¨¡å—

1. **åˆ›å»ºå¯è§†åŒ–å‡½æ•°**
```python
def visualize_lidar_data(file_path):
    """æ¿€å…‰é›·è¾¾æ•°æ®å¯è§†åŒ–"""
    # ç‰¹å®šäºæ¿€å…‰é›·è¾¾çš„å¯è§†åŒ–é€»è¾‘
    pass

def visualize_camera_data(file_path):
    """æ‘„åƒå¤´æ•°æ®å¯è§†åŒ–"""
    # ç‰¹å®šäºæ‘„åƒå¤´çš„å¯è§†åŒ–é€»è¾‘
    pass
```

2. **åœ¨ä¸»é¡µé¢ä¸­é›†æˆ**
```python
def show_visualization_page():
    # ...ç°æœ‰ä»£ç ...
    
    if lidar_files:
        st.subheader("ğŸ“¡ æ¿€å…‰é›·è¾¾æ•°æ®")
        for lidar_file in lidar_files:
            visualize_lidar_data(lidar_file)
    
    if camera_files:
        st.subheader("ğŸ“· æ‘„åƒå¤´æ•°æ®")
        for camera_file in camera_files:
            visualize_camera_data(camera_file)
```

**æ–‡æ¡£æ¥æº**
- [main.py](file://src/main.py)
- [auth.py](file://src/auth.py)

## ä»£ç é£æ ¼ä¸æœ€ä½³å®è·µ

### ä»£ç é£æ ¼è§„èŒƒ

1. **å‘½åè§„èŒƒ**
- å˜é‡åï¼šä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼ˆsnake_caseï¼‰
- å‡½æ•°åï¼šä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼ˆsnake_caseï¼‰
- ç±»åï¼šä½¿ç”¨é©¼å³°å‘½åæ³•ï¼ˆCamelCaseï¼‰
- å¸¸é‡ï¼šä½¿ç”¨å¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼ˆUPPER_CASEï¼‰

2. **æ–‡æ¡£å­—ç¬¦ä¸²**
```python
def function_name(param1, param2):
    """
    å‡½æ•°åŠŸèƒ½æè¿°
    
    Args:
        param1: å‚æ•°1æè¿°
        param2: å‚æ•°2æè¿°
    
    Returns:
        è¿”å›å€¼æè¿°
    
    Raises:
        ExceptionType: å¼‚å¸¸æè¿°
    """
```

3. **ä»£ç æ ¼å¼åŒ–**
ä½¿ç”¨`pyproject.toml`ä¸­çš„é…ç½®è¿›è¡Œä»£ç æ ¼å¼åŒ–ï¼š
```toml
[tool.pyright]
include = ["**/*.py"]
exclude = ["**/node_modules", "**/__pycache__"]
reportMissingImports = false
reportOptionalMemberAccess = false
pythonVersion = "3.9"
```

### æ—¥å¿—è®°å½•å®è·µ

1. **ä½¿ç”¨Streamlitçš„å†…ç½®æ¶ˆæ¯ç³»ç»Ÿ**
```python
st.success("æ“ä½œæˆåŠŸ")
st.error("æ“ä½œå¤±è´¥")
st.warning("è­¦å‘Šä¿¡æ¯")
st.info("æç¤ºä¿¡æ¯")
```

2. **æ·»åŠ è¯¦ç»†çš„é”™è¯¯å¤„ç†**
```python
try:
    # æ“ä½œä»£ç 
    pass
except SpecificException as e:
    st.error(f"å…·ä½“é”™è¯¯: {str(e)}")
except Exception as e:
    st.error(f"æœªçŸ¥é”™è¯¯: {str(e)}")
```

### é”™è¯¯å¤„ç†æœºåˆ¶

1. **è¾“å…¥éªŒè¯**
```python
if not dataset_name or not uploaded_files:
    st.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯")
    return
```

2. **å¼‚å¸¸æ•è·**
```python
try:
    # æ–‡ä»¶æ“ä½œ
    with open(file_path, "wb") as f:
        f.write(file.getvalue())
except PermissionError:
    st.error("æ–‡ä»¶æƒé™ä¸è¶³")
except IOError:
    st.error("æ–‡ä»¶è¯»å†™é”™è¯¯")
```

**æ–‡æ¡£æ¥æº**
- [main.py](file://src/main.py)
- [auth.py](file://src/auth.py)
- [pyproject.toml](file://config/pyproject.toml)

## è°ƒè¯•æŠ€å·§ä¸å¼€å‘å·¥å…·

### è°ƒè¯•æŠ€å·§

1. **ä½¿ç”¨`st.write()`è¿›è¡Œè°ƒè¯•**
```python
st.write("è°ƒè¯•ä¿¡æ¯:", variable)
```

2. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

3. **ä½¿ç”¨`st.expander()`ç»„ç»‡è°ƒè¯•ä¿¡æ¯**
```python
with st.expander("è°ƒè¯•ä¿¡æ¯"):
    st.write("å˜é‡çŠ¶æ€:", variable)
    st.write("å‡½æ•°å‚æ•°:", params)
```

### å¼€å‘å·¥å…·æ¨è

1. **IDE/ç¼–è¾‘å™¨**
- VS Codeï¼šæ¨èä½¿ç”¨Pythonæ‰©å±•
- PyCharmï¼šä¸“ä¸šçš„Python IDE
- Jupyter Notebookï¼šç”¨äºæ•°æ®æ¢ç´¢

2. **è°ƒè¯•å·¥å…·**
- `pdb`ï¼šPythonå†…ç½®è°ƒè¯•å™¨
- `ipdb`ï¼šå¢å¼ºç‰ˆè°ƒè¯•å™¨
- `streamlit run --server.enableCORS=false`ï¼šå¼€å‘æ¨¡å¼å¯åŠ¨

3. **æ€§èƒ½åˆ†æ**
```python
import time
start_time = time.time()
# ä»£ç å—
end_time = time.time()
st.write(f"æ‰§è¡Œæ—¶é—´: {end_time - start_time:.2f}ç§’")
```

**æ–‡æ¡£æ¥æº**
- [main.py](file://src/main.py)
- [demo_login.py](file://src/demo_login.py)

## å®‰å…¨æ€§æœ€ä½³å®è·µ

### ç”¨æˆ·è¾“å…¥å¤„ç†

1. **è¾“å…¥éªŒè¯**
```python
def validate_username(username: str) -> bool:
    """éªŒè¯ç”¨æˆ·åæ ¼å¼"""
    if len(username) < 3 or len(username) > 20:
        return False
    pattern = r'^[a-zA-Z0-9_]+$'
    return re.match(pattern, username) is not None
```

2. **å¯†ç å®‰å…¨**
```python
def validate_password(password: str) -> tuple[bool, str]:
    """éªŒè¯å¯†ç å¼ºåº¦"""
    if len(password) < MIN_PASSWORD_LENGTH:
        return False, f"å¯†ç é•¿åº¦è‡³å°‘ä¸º {MIN_PASSWORD_LENGTH} ä½"
    
    if not re.search(r'[A-Za-z]', password):
        return False, "å¯†ç å¿…é¡»åŒ…å«å­—æ¯"
    
    if not re.search(r'[0-9]', password):
        return False, "å¯†ç å¿…é¡»åŒ…å«æ•°å­—"
    
    return True, "å¯†ç å¼ºåº¦åˆæ ¼"
```

### æ–‡ä»¶ä¸Šä¼ é˜²æŠ¤

1. **æ–‡ä»¶ç±»å‹é™åˆ¶**
```python
uploaded_files = st.file_uploader(
    "é€‰æ‹©æ–‡ä»¶",
    accept_multiple_files=True,
    type=['bag', 'pcd', 'png', 'jpg', 'yaml', 'yml', 'csv', 'json'],
    help="æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š.bag, .pcd, .png, .jpg, .yaml, .yml, .csv, .json"
)
```

2. **æ–‡ä»¶å¤§å°é™åˆ¶**
```python
MAX_FILE_SIZE = 100 * 1024 * 1024  # 100MB
if file.size > MAX_FILE_SIZE:
    st.error("æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶")
    return
```

3. **å®‰å…¨çš„æ–‡ä»¶å­˜å‚¨**
```python
# ä½¿ç”¨å®‰å…¨çš„æ–‡ä»¶è·¯å¾„
timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
dataset_dir = f"datasets/{dataset_name}_{timestamp}"
os.makedirs(dataset_dir, exist_ok=True)
```

### è®¤è¯å®‰å…¨

1. **ä¼šè¯ç®¡ç†**
```python
def create_user_session(user_id: int) -> str:
    """åˆ›å»ºç”¨æˆ·ä¼šè¯"""
    session_token = secrets.token_urlsafe(32)
    expires_at = datetime.now() + timedelta(hours=SESSION_TIMEOUT_HOURS)
    # å­˜å‚¨ä¼šè¯åˆ°æ•°æ®åº“
    return session_token
```

2. **è´¦æˆ·é”å®šæœºåˆ¶**
```python
def increment_failed_login(username: str):
    """å¢åŠ ç™»å½•å¤±è´¥æ¬¡æ•°"""
    c.execute('''
        UPDATE users 
        SET failed_login_attempts = failed_login_attempts + 1 
        WHERE username = ?
    ''', (username,))
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦é”å®šè´¦æˆ·
    if result and result[0] >= MAX_LOGIN_ATTEMPTS:
        # é”å®šè´¦æˆ·1å°æ—¶
        lock_until = datetime.now() + timedelta(hours=1)
        c.execute('''
            UPDATE users 
            SET locked_until = ? 
            WHERE username = ?
        ''', (lock_until.isoformat(), username))
```

**æ–‡æ¡£æ¥æº**
- [auth.py](file://src/auth.py#L38-L80)
- [main.py](file://src/main.py)