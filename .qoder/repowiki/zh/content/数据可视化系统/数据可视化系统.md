# 数据可视化系统

<cite>
**本文档引用的文件**  
- [main.py](file://src/main.py)
</cite>

## 目录
1. [简介](#简介)
2. [点云数据加载机制](#点云数据加载机制)
3. [单文件可视化](#单文件可视化)
4. [多文件对比可视化](#多文件对比可视化)
5. [其他数据类型可视化](#其他数据类型可视化)
6. [Plotly 3D图表配置](#plotly-3d图表配置)
7. [性能优化建议](#性能优化建议)
8. [常见问题与处理](#常见问题与处理)

## 简介
本系统是一个面向无人驾驶领域的多模态数据管理与可视化平台，支持多种传感器数据的上传、浏览和可视化。核心功能之一是强大的点云数据可视化能力，基于Streamlit和Plotly构建，能够高效展示PCD、LAS/LAZ、TXT等格式的三维点云数据，并提供丰富的交互式参数控制。

## 点云数据加载机制

系统通过 `load_point_cloud` 函数实现对多种点云格式的支持，具备良好的容错性和依赖管理。

### 支持的文件格式
- **PCD文件**：使用Open3D库进行读取，支持带颜色信息的点云
- **LAS/LAZ文件**：使用laspy库解析，自动提取XYZ坐标及RGB颜色（若存在）
- **TXT/XYZ文本文件**：通过`numpy.loadtxt`读取，要求至少包含前三列X、Y、Z坐标，第4-6列可选为RGB颜色值

### 降级处理机制
当所需依赖库未安装时，系统会优雅降级并提示用户：
- 若未安装`open3d`，加载PCD文件时将显示错误提示“需要安装 Open3D 库来读取 PCD 文件”
- 若未安装`laspy`，加载LAS/LAZ文件时提示“需要安装 laspy 库来读取 LAS/LAZ 文件”

该机制确保系统在部分依赖缺失的情况下仍可运行其他功能。

**Section sources**
- [main.py](file://src/main.py#L29-L71)

## 单文件可视化

`visualize_single_pointcloud` 函数提供完整的单个点云文件可视化流程，包含统计信息展示、参数调节和交互式渲染。

### 采样策略
为提升大数据集的渲染性能，系统采用随机采样策略：
- 用户可通过滑块设置“最大显示点数”（默认不超过10,000点，上限100,000）
- 当原始点数超过设定值时，使用`np.random.choice`进行无放回随机采样
- 采样后保留原始数据的统计代表性

### 颜色映射模式
支持三种颜色显示方式：
- **高度 (Z)**：以Z轴坐标作为颜色映射依据，使用Viridis色谱，并显示颜色条标注高度值
- **原始颜色**：若点云包含颜色信息，则还原其真实色彩（RGB归一化至0-1范围）
- **均匀颜色**：所有点统一显示为蓝色，适用于无颜色信息或强调结构形态的场景

### 交互式参数控制
用户可通过以下控件自定义可视化效果：
- **点大小**：调节点的渲染尺寸（1-10像素）
- **视角模式**：预设四种相机视角：
  - 3D视角：立体观察
  - 从上向下 (XY)：俯视平面分布
  - 从前向后 (XZ)：侧视剖面
  - 从左向右 (YZ)：正视剖面

**Section sources**
- [main.py](file://src/main.py#L73-L197)

## 多文件对比可视化

`visualize_multiple_pointclouds` 函数支持三种对比模式，便于多数据集分析。

### 并排显示模式
- 允许用户选择多个文件，在两列布局中并列展示各自的3D视图
- 每个视图独立渲染，便于比较不同点云的空间分布
- 为保证性能，每文件最多显示5,000个点

### 剔叠显示模式
- 将多个点云叠加在同一3D坐标系中
- 不同文件使用不同颜色区分（红、蓝、绿等预定义调色板）
- 支持统一调节每个文件的最大显示点数
- 图例标注各点云来源文件名，适合空间重合度分析

### 统计对比分析模式
- 自动提取各点云的关键统计指标：
  - 点数量
  - XYZ坐标范围与均值
  - 文件大小（MB）
  - 是否含颜色信息
- 生成结构化对比表格
- 提供柱状图可视化：
  - 点数量对比图
  - 文件大小对比图

此模式适用于快速评估多个数据集的质量和规模差异。

**Section sources**
- [main.py](file://src/main.py#L199-L380)

## 其他数据类型可视化

系统支持多种非点云数据的可视化方法，统一集成于数据可视化页面。

### 图像数据
- 支持PNG、JPG/JPEG格式
- 最多显示9张缩略图（3×3网格布局）
- 使用Pillow库加载并直接通过Streamlit渲染

### CSV数据
- 使用Pandas读取表格数据
- 显示前100行内容
- 自动生成基本统计图表：
  - 数值列之间的散点图
  - 单列数据的直方图

### YAML与JSON配置文件
- 使用对应解析器读取结构化数据
- 通过`st.json`组件以可折叠树形结构展示内容
- 便于查看传感器参数、系统配置等元信息

这些功能使得平台不仅能处理原始传感器数据，还能关联分析配置与结果。

**Section sources**
- [main.py](file://src/main.py#L575-L690)

## Plotly 3D图表配置

系统使用Plotly实现高质量3D点云渲染，关键配置如下：

### 相机视角设置
通过`camera_settings`字典预定义视角参数：
```python
camera_settings = {
    "3D 视角": dict(eye=dict(x=1.5, y=1.5, z=1.5)),
    "从上向下 (XY)": dict(eye=dict(x=0, y=0, z=3)),
    "从前向后 (XZ)": dict(eye=dict(x=0, y=3, z=0)),
    "从左向右 (YZ)": dict(eye=dict(x=3, y=0, z=0))
}
```
利用`scene.camera.eye`控制观察方向，实现不同剖面的快速切换。

### 标记样式
- **点大小**：由用户滑块控制，传递给`marker.size`
- **透明度**：固定为0.8（并排/叠加模式为0.7/0.6），避免遮挡
- **悬停信息**：仅前100个点显示详细坐标，提升响应速度

### 布局设置
- 场景标题动态显示文件名
- 坐标轴标签为X、Y、Z
- `aspectmode='cube'`保持三维空间比例一致
- 高度设为600px，适配主流屏幕

**Section sources**
- [main.py](file://src/main.py#L144-L185)

## 性能优化建议

针对大规模点云数据，系统采取多项优化措施：

### 采样策略
- 默认限制最大显示点数为10,000（可调）
- 使用`np.random.choice(..., replace=False)`确保无重复采样
- 并排模式进一步限制为5,000点/文件

### 内存与渲染优化
- 仅在需要时加载数据（惰性加载）
- 使用`st.spinner`提示加载状态，提升用户体验
- 悬停信息仅生成前100个点，减少DOM负担
- 所有图表启用`use_container_width=True`自适应布局

### 推荐实践
- 对超大点云（>10万点），建议先降采样再上传
- 多文件叠加时，控制每文件点数在2,000以内
- 利用“对比分析”模式替代全量渲染，提高分析效率

**Section sources**
- [main.py](file://src/main.py#L106-L148)

## 常见问题与处理

### Open3D未安装时的降级处理
系统在导入时尝试加载`open3d`，失败后设置`OPEN3D_AVAILABLE = False`，并在UI中提示用户安装命令：
```
pip install open3d
```
此设计避免因单一依赖导致整个应用崩溃。

### 大文件加载缓慢
- **现象**：超过10万点的PCD或LAS文件加载耗时较长
- **解决方案**：
  1. 后端增加进度提示（`st.spinner`）
  2. 前端建议用户使用外部工具预采样
  3. 数据库记录文件元信息，避免重复解析

### 文件路径不存在
系统在显示图像等资源前检查`os.path.exists`，防止因路径错误导致崩溃。

### 类型兼容性问题
- LAS文件颜色值为16位整数，需除以65535.0归一化至[0,1]
- TXT文件要求至少3列，颜色列需连续且完整（3列或6列）

以上机制保障了系统在复杂真实环境下的鲁棒性。

**Section sources**
- [main.py](file://src/main.py#L57-L71)
- [main.py](file://src/main.py#L611-L638)