# 无人驾驶数据管理平台架构设计文档

## 1. 项目概述

### 1.1 项目背景
无人驾驶数据管理平台是一个专门用于管理和共享无人驾驶相关多模态传感器数据的Web应用程序。该平台基于Streamlit框架开发，提供用户认证、数据管理、点云可视化等核心功能。

### 1.2 技术栈
- **前端框架**: Streamlit 1.29.0
- **后端语言**: Python 3.13
- **数据库**: SQLite 3
- **数据处理**: NumPy, Pandas
- **可视化**: Plotly, Open3D
- **图像处理**: OpenCV, Pillow
- **构建工具**: Maven（配置管理）
- **依赖管理**: pip + requirements.txt

### 1.3 支持的数据格式
- **点云数据**: .pcd, .las/.laz, .txt/.xyz
- **ROS数据**: .bag
- **图像数据**: .png, .jpg, .jpeg
- **配置文件**: .yaml, .yml
- **传感器数据**: .csv, .json

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层 (Presentation Layer)            │
├─────────────────────────────────────────────────────────────┤
│  Streamlit Frontend                                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ 登录页面 │  │ 首页面板 │  │ 数据管理 │  │ 可视化  │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    业务逻辑层 (Business Logic Layer)         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ 用户认证 │  │ 数据处理 │  │ 文件管理 │  │ 可视化引擎│        │
│  │ 模块    │  │ 模块    │  │ 模块    │  │ 模块     │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    数据访问层 (Data Access Layer)            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                     │
│  │ 用户数据 │  │ 会话数据 │  │ 数据集   │                     │
│  │ 访问    │  │ 访问    │  │ 访问     │                     │
│  └─────────┘  └─────────┘  └─────────┘                     │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    数据存储层 (Data Storage Layer)           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐                                  │
│  │ SQLite  │  │ 文件系统 │                                  │
│  │ 数据库  │  │ 存储    │                                  │
│  └─────────┘  └─────────┘                                  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 架构特点

#### 2.2.1 分层设计
- **表现层分离**: 使用Streamlit框架实现前端界面与业务逻辑分离
- **业务逻辑模块化**: 各功能模块独立开发，便于维护和扩展
- **数据访问抽象**: 统一的数据库访问接口，支持未来迁移到其他数据库
- **存储灵活**: 元数据存储在SQLite，实际文件存储在文件系统

#### 2.2.2 安全设计
- **身份认证**: 基于用户名/密码的认证机制
- **会话管理**: 基于Token的会话机制，支持过期管理
- **密码安全**: PBKDF2算法加密存储密码
- **访问控制**: 防暴力破解机制，账户锁定保护

#### 2.2.3 扩展性设计
- **插件化架构**: 可视化模块支持多种数据格式扩展
- **配置驱动**: 使用配置文件管理依赖和环境
- **模块解耦**: 各模块间低耦合，便于独立测试和部署

## 3. 核心模块设计

### 3.1 用户认证模块 (auth.py)

#### 3.1.1 功能职责
- 用户注册与登录验证
- 密码安全管理
- 会话生命周期管理
- 安全策略实施

#### 3.1.2 核心组件
```python
# 核心类设计
class AuthenticationManager:
    - hash_password()          # 密码哈希
    - validate_credentials()   # 凭证验证
    - create_session()        # 会话创建
    - verify_session()        # 会话验证
    
class UserValidator:
    - validate_username()     # 用户名校验
    - validate_email()        # 邮箱校验  
    - validate_password()     # 密码强度校验

class SecurityManager:
    - check_login_attempts()  # 登录尝试检查
    - lock_user_account()     # 账户锁定
    - clear_user_lock()       # 解除锁定
```

#### 3.1.3 数据模型
```sql
-- 用户表
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    salt TEXT NOT NULL,
    created_at TEXT NOT NULL,
    last_login TEXT,
    is_active INTEGER DEFAULT 1,
    failed_login_attempts INTEGER DEFAULT 0,
    locked_until TEXT
);

-- 会话表  
CREATE TABLE user_sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    session_token TEXT UNIQUE NOT NULL,
    created_at TEXT NOT NULL,
    expires_at TEXT NOT NULL,
    is_active INTEGER DEFAULT 1,
    FOREIGN KEY (user_id) REFERENCES users (id)
);
```

### 3.2 数据管理模块 (main.py - 数据部分)

#### 3.2.1 功能职责
- 数据集元数据管理
- 文件上传和存储
- 数据浏览和检索
- 数据集生命周期管理

#### 3.2.2 核心组件
```python
class DatasetManager:
    - create_dataset()        # 创建数据集
    - upload_files()          # 文件上传
    - list_datasets()         # 数据集列表
    - delete_dataset()        # 删除数据集
    
class FileManager:
    - save_uploaded_file()    # 保存上传文件
    - validate_file_type()    # 文件类型验证
    - get_file_metadata()     # 文件元数据提取
    
class SearchEngine:
    - search_datasets()       # 数据集搜索
    - filter_by_type()        # 按类型过滤
    - sort_results()          # 结果排序
```

#### 3.2.3 数据模型
```sql
-- 数据集表
CREATE TABLE datasets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    upload_time TEXT,
    file_count INTEGER DEFAULT 0,
    file_paths TEXT
);
```

### 3.3 可视化模块 (main.py - 可视化部分)

#### 3.3.1 功能职责
- 多格式点云数据加载
- 2D/3D数据可视化
- 交互式数据探索
- 多数据源对比分析

#### 3.3.2 核心组件
```python
class PointCloudProcessor:
    - load_point_cloud()      # 点云加载
    - sample_points()         # 点云采样
    - extract_statistics()    # 统计信息提取
    
class VisualizationEngine:
    - create_3d_plot()        # 3D可视化
    - create_comparison_plot() # 对比可视化
    - apply_color_mapping()   # 颜色映射
    
class DataAnalyzer:
    - calculate_statistics()  # 统计分析
    - generate_reports()      # 报告生成
    - compare_datasets()      # 数据集对比
```

#### 3.3.3 支持的可视化类型
- **单点云可视化**: 详细的3D点云展示，支持多种颜色映射
- **多点云对比**: 并排显示、叠加显示、统计对比
- **数据统计图表**: 点数量对比、文件大小对比、坐标分布图

### 3.4 Web界面模块 (main.py - UI部分)

#### 3.4.1 页面结构
```
┌─────────────────────────────────────────┐
│              应用主界面                  │
├─────────────────────────────────────────┤
│  侧边栏导航    │     主内容区域          │
│  ┌─────────┐   │  ┌─────────────────┐   │
│  │ 首页    │   │  │                 │   │
│  │ 数据上传 │   │  │   动态内容区域   │   │  
│  │ 数据浏览 │   │  │                 │   │
│  │ 数据可视化│   │  │                 │   │
│  │ 用户信息 │   │  └─────────────────┘   │
│  └─────────┘   │                       │
└─────────────────────────────────────────┘
```

#### 3.4.2 页面功能
- **首页**: 平台介绍、统计信息、快速导航
- **数据上传**: 数据集创建、文件上传、批量操作
- **数据浏览**: 数据集管理、搜索过滤、文件预览
- **数据可视化**: 多格式数据展示、交互式分析

## 4. 技术实现细节

### 4.1 数据库设计

#### 4.1.1 设计原则
- **简单高效**: 使用SQLite满足单机部署需求
- **规范化**: 遵循数据库范式，避免数据冗余
- **扩展性**: 预留字段支持功能扩展
- **完整性**: 外键约束保证数据一致性

#### 4.1.2 索引策略
```sql
-- 用户查询优化
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);

-- 会话查询优化  
CREATE INDEX idx_sessions_token ON user_sessions(session_token);
CREATE INDEX idx_sessions_user ON user_sessions(user_id);

-- 数据集查询优化
CREATE INDEX idx_datasets_name ON datasets(name);
CREATE INDEX idx_datasets_time ON datasets(upload_time);
```

### 4.2 文件存储策略

#### 4.2.1 目录结构
```
datasets/
├── {dataset_name}_{timestamp}/
│   ├── file1.pcd
│   ├── file2.png
│   └── config.yaml
└── temp_pointclouds/
    ├── sample_sphere.txt
    └── sample_sphere_colored.txt
```

#### 4.2.2 文件管理策略
- **时间戳命名**: 避免目录名冲突
- **类型分类**: 支持多种文件格式统一管理
- **临时文件**: 独立临时目录管理测试数据
- **清理机制**: 删除数据集时清理相关文件

### 4.3 安全机制

#### 4.3.1 认证安全
- **密码加密**: PBKDF2-HMAC-SHA256，100,000次迭代
- **盐值随机**: 每个用户独立的32字节随机盐值
- **会话管理**: 24小时过期Token机制
- **防暴力破解**: 5次失败锁定1小时

#### 4.3.2 输入验证
- **用户名**: 3-20位字母数字下划线
- **邮箱**: 标准邮箱格式验证
- **密码**: 最少6位，包含字母和数字
- **文件类型**: 白名单方式验证上传文件

### 4.4 性能优化

#### 4.4.1 点云处理优化
- **智能采样**: 大数据集自动采样显示
- **分级加载**: 概览->详细的分级加载策略
- **内存管理**: 及时释放大型数组内存
- **异步处理**: 使用Streamlit缓存机制

#### 4.4.2 界面响应优化
- **渐进式加载**: 分步骤显示加载进度
- **缓存策略**: 缓存数据库查询结果
- **懒加载**: 按需加载可视化组件
- **批量操作**: 支持批量文件处理

## 5. 部署架构

### 5.1 单机部署架构

```
┌─────────────────────────────────────────┐
│            用户浏览器                    │ 
│     http://localhost:8501              │
└─────────────┬───────────────────────────┘
              │ HTTP
┌─────────────▼───────────────────────────┐
│         Streamlit Server                │
│  ┌─────────────────────────────────┐    │
│  │        Python 应用进程           │    │
│  │  ┌─────────┐  ┌─────────────┐   │    │
│  │  │ main.py │  │   auth.py   │   │    │
│  │  └─────────┘  └─────────────┘   │    │
│  └─────────────────────────────────┘    │
└─────────────┬───────────────────────────┘
              │ File I/O
┌─────────────▼───────────────────────────┐
│          本地存储                        │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │   data.db   │  │    datasets/    │   │
│  │ (SQLite)    │  │  (文件存储)      │   │
│  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────┘
```

### 5.2 环境要求

#### 5.2.1 硬件要求
- **CPU**: 双核以上，支持多线程
- **内存**: 最少4GB，推荐8GB以上
- **硬盘**: 10GB以上可用空间
- **网络**: 本地网络或公网连接

#### 5.2.2 软件要求
- **操作系统**: Windows 10/11, Linux, macOS
- **Python**: 3.13或以上版本
- **浏览器**: Chrome, Firefox, Edge (现代浏览器)

### 5.3 启动流程

#### 5.3.1 自动化脚本
- **Windows**: start_app.bat
- **Linux/Mac**: start_app.sh

#### 5.3.2 启动步骤
1. 环境检查与依赖安装
2. 数据库初始化
3. 测试数据生成
4. Web服务启动
5. 浏览器自动打开

## 6. 质量保证

### 6.1 测试策略

#### 6.1.1 单元测试
- **认证模块测试** (test_auth.py)
  - 用户注册功能测试
  - 登录验证测试
  - 会话管理测试
  - 安全策略测试

- **点云模块测试** (test_pointcloud.py)
  - 多格式加载测试
  - 数据验证测试
  - 可视化功能测试

#### 6.1.2 集成测试
- **端到端流程测试**
  - 用户完整操作流程
  - 数据上传到可视化流程
  - 多用户并发访问测试

#### 6.1.3 测试框架解耦
- 测试代码独立于Streamlit框架
- 可在无GUI环境下运行
- 支持自动化持续集成

### 6.2 代码质量

#### 6.2.1 编码规范
- **PEP 8**: Python代码风格规范
- **类型提示**: 使用Type Hints提高代码可读性
- **文档字符串**: 完善的函数和类文档
- **模块化设计**: 单一职责原则

#### 6.2.2 错误处理
- **异常捕获**: 完善的异常处理机制
- **用户友好**: 错误信息对用户友好
- **日志记录**: 详细的操作日志
- **优雅降级**: 依赖缺失时的功能降级

## 7. 运维管理

### 7.1 监控指标

#### 7.1.1 系统指标
- **内存使用**: Python进程内存占用
- **磁盘空间**: 数据集存储空间
- **网络连接**: 并发用户连接数
- **响应时间**: 页面加载和数据处理时间

#### 7.1.2 业务指标
- **用户活跃度**: 登录用户统计
- **数据使用量**: 上传数据集数量和大小
- **功能使用**: 各功能模块访问统计
- **错误率**: 系统错误发生频率

### 7.2 维护策略

#### 7.2.1 数据备份
- **数据库备份**: 定期备份SQLite数据库文件
- **文件备份**: 重要数据集文件备份
- **配置备份**: 系统配置文件备份
- **恢复测试**: 定期验证备份可用性

#### 7.2.2 版本管理
- **代码版本控制**: Git管理代码变更
- **依赖版本固定**: requirements.txt锁定版本
- **升级策略**: 渐进式升级和回滚机制
- **兼容性测试**: 新版本兼容性验证

## 8. 扩展规划

### 8.1 功能扩展

#### 8.1.1 短期规划 (3-6个月)
- **用户权限管理**: 角色权限控制
- **数据集共享**: 用户间数据共享
- **批量操作**: 批量数据处理功能
- **导出功能**: 数据导出和报告生成

#### 8.1.2 中期规划 (6-12个月)
- **分布式存储**: 支持云存储集成
- **实时协作**: 多用户实时编辑
- **API接口**: RESTful API支持
- **移动适配**: 移动设备界面优化

#### 8.1.3 长期规划 (1-2年)
- **微服务架构**: 拆分为微服务架构
- **容器化部署**: Docker容器化支持
- **机器学习集成**: AI算法集成平台
- **企业级功能**: 企业版功能开发

### 8.2 技术架构演进

#### 8.2.1 架构升级路径
```
当前单体架构 → 模块化架构 → 微服务架构 → 云原生架构
```

#### 8.2.2 技术栈演进
- **前端**: Streamlit → React/Vue + Streamlit
- **后端**: Python单体 → FastAPI微服务
- **数据库**: SQLite → PostgreSQL/MongoDB
- **部署**: 单机 → 容器 → K8s集群

## 9. 总结

本无人驾驶数据管理平台采用分层架构设计，具有良好的模块化、扩展性和维护性。通过合理的技术选型和架构设计，实现了：

1. **功能完备**: 覆盖用户认证、数据管理、可视化分析等核心需求
2. **安全可靠**: 完善的安全机制和错误处理
3. **易于使用**: 直观的Web界面和用户体验
4. **易于维护**: 模块化设计和完善的测试体系
5. **易于扩展**: 预留扩展接口和升级路径

该架构为无人驾驶数据处理提供了一个稳定、高效的基础平台，能够满足当前需求并支持未来的功能扩展。